name: 🚀 Streamlined CI (Qodo-Optimized)

# Optimierte CI Pipeline - Style/Quality Checks werden von Qodo übernommen
# Fokus auf Build-kritische und Funktions-Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  checks: read

env:
  NODE_VERSION: '20'

jobs:
  # Nur noch Essential CI Checks - Rest macht Qodo
  essential-checks:
    name: 🔧 Essential Build & Function Checks
    runs-on: ubuntu-latest
    
    steps:
      - name: 📥 Checkout
        uses: actions/checkout@v4

      - name: 🏗️ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: |
            package-lock.json

      - name: 📦 Install dependencies
        run: npm ci --prefer-offline --no-audit

      - name: ⏳ Wait for Qodo check to pass (max 10m)
        if: ${{ github.event_name == 'pull_request' }}
        uses: actions/github-script@v7
        env:
          QODO_CHECK_NAME: Qodo
        with:
          script: |
            const checkName = process.env.QODO_CHECK_NAME || 'Qodo'
            const owner = context.repo.owner
            const repo = context.repo.repo
            let ref = context.sha
            if (context.eventName === 'pull_request' && context.payload.pull_request?.head?.sha) {
              ref = context.payload.pull_request.head.sha
            }
            core.info(`Waiting for check '${checkName}' on ${owner}/${repo}@${ref}`)
            const sleep = (ms) => new Promise(r => setTimeout(r, ms))
            for (let i = 0; i < 60; i++) {
              const res = await github.rest.checks.listForRef({ owner, repo, ref, per_page: 100 })
              const cr = res.data.check_runs.find(c => (c.name || '').includes(checkName))
              if (!cr) {
                await sleep(10000)
                continue
              }
              if (cr.status !== 'completed') {
                await sleep(10000)
                continue
              }
              if (cr.conclusion === 'success') {
                core.info(`Qodo check passed. details: ${cr.details_url || 'n/a'}`)
                return
              }
              core.setFailed(`Qodo check failed: ${cr.conclusion}. details: ${cr.details_url || 'n/a'}`)
              return
            }
            core.setFailed('Timed out waiting for Qodo check to pass')

      # ✅ Build-kritische TypeScript Compilation (bleibt in CI)
      - name: 🔍 TypeScript Build Check
        run: npm run typecheck

      # ⚡ Unit Tests werden jetzt in Azure Free Tier ausgeführt
      - name: 📋 Unit Tests Status
        run: |
          echo "⚡ Unit Tests werden in Azure Static Web Apps Free Tier ausgeführt"
          echo "🔗 Tests sind Teil der Azure Build Pipeline"
          echo "✅ Deployment schlägt fehl wenn Tests nicht bestehen"

      # ✅ Build Validation (bleibt in CI)
      - name: 🏗️ Production Build
        run: npm run build

  # ✅ E2E Tests (bleibt in CI - kann nicht von Qodo gemacht werden)
  e2e-tests:
    name: 🎭 E2E Tests
    runs-on: ubuntu-latest
    needs: essential-checks
    
    steps:
      - name: 📥 Checkout
        uses: actions/checkout@v4

      - name: 🏗️ Setup Node.js  
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: |
            package-lock.json

      - name: 📦 Install dependencies
        run: npm ci --prefer-offline --no-audit

      # Install Playwright browsers (nur Chromium, keine OS-Dependencies)
      - name: 🎭 Install Playwright Browsers (Chromium)
        run: npx playwright install chromium

      - name: 🎭 Run Playwright Tests
        env:
          PLAYWRIGHT_SKIP_VALIDATE_HOST_REQUIREMENTS: '1'
        run: npm run test:e2e

      - name: 📊 Upload Playwright Report
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report/

  # ✅ Nur noch Error-Level ESLint (Style Rules → Qodo)
  critical-lint:
    name: 🚨 Critical Lint Errors Only
    runs-on: ubuntu-latest
    
    steps:
      - name: 📥 Checkout
        uses: actions/checkout@v4

      - name: 🏗️ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: 📦 Install dependencies
        run: npm ci --prefer-offline --no-audit

      # Nur Error-Level (Style → Qodo)
      - name: 🚨 ESLint Critical Errors Only
        run: npm run lint -- --quiet --max-warnings=0

  # ❌ ENTFERNTE CHECKS (jetzt Qodo):
  # - Prettier formatting
  # - Markdownlint  
  # - Dependency vulnerability scan
  # - Code style violations (non-error)
  # - Vue/Nuxt best practices
  # - JSDoc documentation quality
  # - TypeScript advanced patterns